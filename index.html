<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <title>Mapa Din&aacute;mico SNIEn</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.maptiler.com/maptiler-sdk-js/v3.6.1/maptiler-sdk.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />


</head>

<body>
    <div id="preloader">
        <div class="preloader-content" role="status" aria-live="polite">
            <div class="spinner"></div>
            <p>Cargando informaci&oacute;n geoespacial...</p>
        </div>
    </div>

    <!-- Pantalla de Bienvenida -->
    <div id="welcome-screen" class="welcome-screen">
        <div class="welcome-content">
            <div class="welcome-header">
                <img src="img/logo_sener.png" alt="SENER" class="welcome-logo-sener">
                <div class="welcome-title-container">
                    <h1 class="welcome-title">Automatizaci√≥n de Mapas SNIEn</h1>
                    <p class="welcome-subtitle">Sistema Nacional de Informaci√≥n Energ√©tica</p>
                </div>
                <img src="img/SNIEN.png" alt="SNIEn" class="welcome-logo-snien">
            </div>

            <div class="welcome-instructions">
                <div class="instruction-item">
                    <div class="instruction-number">1</div>
                    <div class="instruction-content">
                        <h3>Seleccione un Instrumento</h3>
                        <p>Elija entre PLADESE, PLADESHI, PLATEASE, PROSENER u otros instrumentos energ√©ticos
                            disponibles.</p>
                    </div>
                </div>

                <div class="instruction-item">
                    <div class="instruction-number">2</div>
                    <div class="instruction-content">
                        <h3>Elija un Mapa</h3>
                        <p>Seleccione el mapa espec√≠fico que desea visualizar seg√∫n el instrumento elegido.</p>
                    </div>
                </div>

                <div class="instruction-item">
                    <div class="instruction-number">3</div>
                    <div class="instruction-content">
                        <h3>Interact√∫e con el Mapa</h3>
                        <p>Haga clic en regiones, acerque/aleje el zoom y explore la informaci√≥n geoespacial.</p>
                    </div>
                </div>

                <div class="instruction-item">
                    <div class="instruction-number">4</div>
                    <div class="instruction-content">
                        <h3>Consulte los Datos</h3>
                        <p>Los datos se actualizan autom√°ticamente desde Google Sheets. Use el bot√≥n "Actualizar datos"
                            si es necesario.</p>
                    </div>
                </div>
            </div>

            <button id="welcome-start-btn" class="welcome-btn">
                Comenzar
            </button>

            <div class="welcome-footer">
                <p>Secretar√≠a de Energ√≠a - Sistema Nacional de Informaci√≥n Energ√©tica</p>
            </div>
        </div>
    </div>

    <header class="site-header">
        <div class="container header-content">
            <div class="brand">
                <div class="brand-logos">
                    <img src="img/logo_sener.png" alt="Logo SENER" class="brand-logo brand-logo--sener" />
                    <img src="img/snien.png" alt="Logo Sistema Nacional de Informaci√≥n Energ√©tica"
                        class="brand-logo brand-logo--snien" />
                </div>
                <div class="brand-copy">
                    <span class="brand-eyebrow">Secretar&iacute;a de Energ&iacute;a</span>
                    <span class="brand-title">Mapa din&aacute;mico SNIEn</span>
                </div>
            </div>
            <div class="header-meta">
                <span class="meta-label">Actualizaci&oacute;n</span>
                <span id="last-updated" class="meta-value">--</span>
            </div>
        </div>
    </header>

    <main class="page-content">
        <section class="map-section">
            <div class="container">
                <div class="map-card">
                    <div class="card-toolbar">
                        <div class="toolbar-group">
                            <label for="instrument-select">Instrumentos</label>
                            <select id="instrument-select" class="control">
                                <option value="">Seleccione un instrumento</option>
                                <option value="PLADESE">PLADESE</option>
                                <option value="PLADESHI">PLADESHI</option>
                                <option value="PLATEASE">PLATEASE</option>
                                <option value="PROSENER">PROSENER</option>
                                <option value="ELECTRICIDAD">ELECTRICIDAD</option>
                                <option value="GAS NATURAL">GAS NATURAL</option>
                                <option value="GAS L.P.">GAS L.P.</option>
                                <option value="PETROLIFEROS">PETROLIFEROS</option>
                            </select>
                        </div>
                        <div class="toolbar-group">
                            <label for="map-select">Mapa</label>
                            <select id="map-select" class="control" disabled>
                                <option value="">Seleccione un mapa</option>
                            </select>
                        </div>
                        <div class="toolbar-group sheet-info-group">
                            <span class="sheet-info-label">Hoja de c&aacute;lculo</span>
                            <span id="sheet-info" class="sheet-info-value">Sin fuente de datos seleccionada.</span>
                        </div>
                        <div class="toolbar-group" id="search-group" style="display: none;">
                            <label for="permit-search">Buscar permiso</label>
                            <div class="search-container">
                                <input type="text" id="permit-search" class="control" placeholder="N√∫mero de permiso o raz√≥n social" style="max-width: 250px;" autocomplete="off">
                                <button type="button" id="search-help-btn" class="search-help-btn" title="Ayuda de b√∫squeda">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                                <div id="search-suggestions" class="search-suggestions" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="toolbar-group">
                            <button type="button" id="refresh-data" class="btn-secondary btn-icon"
                                title="Actualizar datos">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <div class="toolbar-group">
                            <div class="export-buttons">
                                <button type="button" id="export-pdf" class="btn-export btn-export--pdf btn-icon"
                                    title="Exportar como PDF">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </button>
                                <button type="button" id="export-png" class="btn-export btn-export--png btn-icon"
                                    title="Exportar como PNG">
                                    <i class="bi bi-file-earmark-image"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="map-title-banner" aria-live="polite">
                        <h2 id="map-title-display" class="map-title-text">
                            Mapa SNIEn - Sistema Nacional de Informaci&oacute;n Energ&eacute;tica
                        </h2>
                    </div>

                    <div id="map" class="map-view" role="region" aria-label="Mapa interactivo del SNIEn">
                        <div id="selected-region-banner" class="selected-region-banner" style="display: none;"
                            aria-live="polite">
                            <span id="selected-region-text"></span>
                        </div>
                    </div>
                    
                    <!-- Panel de Filtros y Estad√≠sticas (solo para electricidad) -->
                    <div id="electricity-filters-panel" class="filters-panel" style="display: none;">
                        <div class="filters-header">
                            <h3>üìä Estad√≠sticas y Filtros</h3>
                            <button id="reset-filters-btn" class="btn-secondary btn-small">
                                <i class="bi bi-arrow-counterclockwise"></i> Ver Todos
                            </button>
                        </div>
                        
                        <!-- Totales Generales -->
                        <div class="totals-section">
                            <div class="total-card total-general">
                                <div class="total-icon">‚ö°</div>
                                <div class="total-content">
                                    <div class="total-label">Capacidad Total</div>
                                    <div class="total-value" id="total-capacity">0 MW</div>
                                </div>
                            </div>
                            <div class="total-card total-general">
                                <div class="total-icon">üîã</div>
                                <div class="total-content">
                                    <div class="total-label">Generaci√≥n Anual</div>
                                    <div class="total-value" id="total-generation">0 GWh</div>
                                </div>
                            </div>
                            <div class="total-card total-general">
                                <div class="total-icon">üìç</div>
                                <div class="total-content">
                                    <div class="total-label">Permisos</div>
                                    <div class="total-value" id="total-permits">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabs para GCR y Tecnolog√≠a -->
                        <div class="filters-tabs">
                            <button class="filter-tab active" data-tab="state">Por Estado</button>
                            <button class="filter-tab" data-tab="gcr">Por Gerencia</button>
                            <button class="filter-tab" data-tab="tech">Por Tecnolog√≠a</button>
                            <button class="filter-tab" data-tab="matrix">Vista Detallada</button>
                        </div>
                        
                        <!-- Contenido de Tabs -->
                        <div class="filters-content">
                            <!-- Filtros por Estado (Entidad Federativa) -->
                            <div id="state-filters" class="filter-tab-content active">
                                <div id="state-cards" class="filter-cards"></div>
                            </div>
                            
                            <!-- Filtros por GCR (Gerencia de Control Regional) -->
                            <div id="gcr-filters" class="filter-tab-content">
                                <div id="gcr-cards" class="filter-cards"></div>
                            </div>
                            
                            <!-- Filtros por Tecnolog√≠a -->
                            <div id="tech-filters" class="filter-tab-content">
                                <div id="tech-cards" class="filter-cards"></div>
                            </div>
                            
                            <!-- Vista Detallada GCR x Tecnolog√≠a -->
                            <div id="matrix-filters" class="filter-tab-content">
                                <div id="matrix-view" class="matrix-view"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="map-description" class="map-description">
                        <h4 id="map-description-title"></h4>
                        <p id="map-description-content"></p>
                    </div>
                    <div class="card-footer">
                        <p class="data-source">
                            Fuente de datos: Hoja de c&aacute;lculo institucional publicada (Google Sheets).
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <section class="info-section">
            <div class="container info-grid">
                <article class="info-panel">
                    <h2>Prop&oacute;sito</h2>
                    <p>
                        Este geovisor permite visualizar capas del Sistema Nacional de Informaci&oacute;n
                        Energ&eacute;tica con
                        mapas base personalizados MapTiler y datos abiertos que se actualizan desde Google Sheets.
                    </p>
                </article>
                <article class="info-panel">
                    <h3>Recomendaciones de uso</h3>
                    <ul>
                        <li>Usa el control de capas en el mapa para cambiar el mapa base y activar/desactivar capas.
                        </li>
                        <li>Usa la acci&oacute;n &ldquo;Actualizar datos&rdquo; tras editar la hoja de c&aacute;lculo.
                        </li>
                        <li>Acerca o aleja el mapa hasta el detalle deseado; el visor mantiene el enfoque en
                            M&eacute;xico.</li>
                        <li>Exporta el mapa en PDF o PNG con las configuraciones que necesites.</li>
                    </ul>
                </article>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="container footer-content">
            <div class="footer-logos">
                <img src="img/logo_gob.png" alt="Gobierno de M&eacute;xico" />
                <img src="img/logo_sener.png" alt="Secretar&iacute;a de Energ&iacute;a" />
            </div>
            <p>Sistema Nacional de Informaci&oacute;n Energ&eacute;tica &middot; Secretar&iacute;a de Energ&iacute;a</p>
        </div>
    </footer>

    <!-- Modal de ayuda de b√∫squeda -->
    <div id="search-help-modal" class="modal" role="dialog" aria-labelledby="search-help-modal-title" aria-hidden="true" style="display: none;">
        <div class="modal-overlay" aria-hidden="true"></div>
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="search-help-modal-title" class="modal-title">
                    <i class="bi bi-search"></i> Ayuda del Buscador de Permisos
                </h3>
                <button type="button" class="modal-close search-help-modal-close" aria-label="Cerrar modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <div class="search-help-content">
                    <div class="search-help-section">
                        <h4><i class="bi bi-info-circle-fill" style="color: var(--color-verde-profundo);"></i> C√≥mo usar el buscador</h4>
                        <ul class="search-help-list">
                            <li><strong>Escribe</strong> el n√∫mero de permiso o raz√≥n social en el campo de b√∫squeda</li>
                            <li>La b√∫squeda es <strong>en tiempo real</strong> (m√≠nimo 2 caracteres)</li>
                            <li>Usa las <strong>flechas ‚Üë‚Üì</strong> del teclado para navegar por los resultados</li>
                            <li>Presiona <strong>Enter</strong> para seleccionar un resultado</li>
                            <li>Presiona <strong>Esc</strong> para cerrar las sugerencias</li>
                        </ul>
                    </div>

                    <div class="search-help-section">
                        <h4><i class="bi bi-funnel-fill" style="color: var(--color-guinda);"></i> B√∫squeda con filtros</h4>
                        <p class="search-help-highlight" id="search-help-status">
                            <!-- Se actualiza din√°micamente con JavaScript -->
                        </p>
                        <p class="search-help-description">
                            El buscador <strong>respeta los filtros activos</strong>. Si tienes un filtro aplicado 
                            (Estado, GCR o Tecnolog√≠a), la b√∫squeda solo mostrar√° resultados dentro de ese filtro.
                        </p>
                    </div>

                    <div class="search-help-section">
                        <h4><i class="bi bi-lightbulb-fill" style="color: #f0ad4e;"></i> Consejos √∫tiles</h4>
                        <ul class="search-help-list">
                            <li>Aplica <strong>filtros</strong> antes de buscar para resultados m√°s precisos</li>
                            <li>Puedes buscar por <strong>parte del nombre</strong> de la empresa</li>
                            <li>Los resultados muestran: Estado, Capacidad (MW) y Tecnolog√≠a</li>
                            <li>Al seleccionar, el mapa se centra autom√°ticamente en el permiso</li>
                        </ul>
                    </div>

                    <div class="search-help-example">
                        <h5><i class="bi bi-code-square"></i> Ejemplo:</h5>
                        <div class="search-help-example-box">
                            <p><strong>1.</strong> Aplica filtro "Por Estado" ‚Üí Selecciona "09 CDMX"</p>
                            <p><strong>2.</strong> Escribe en el buscador: "G/123"</p>
                            <p><strong>3.</strong> Solo ver√°s permisos de CDMX que coincidan</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: center; padding: 20px;">
                <button type="button" class="btn-primary search-help-modal-close">
                    Entendido
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de configuraci√≥n de exportaci√≥n -->
    <div id="export-modal" class="modal" role="dialog" aria-labelledby="export-modal-title" aria-hidden="true">
        <div class="modal-overlay" aria-hidden="true"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="export-modal-title" class="modal-title">Configurar exportaci√≥n</h3>
                <button type="button" class="modal-close" aria-label="Cerrar modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="export-config-form" class="export-form">
                    <div class="form-section">
                        <h4 class="form-section-title">Formato de archivo</h4>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="format" value="pdf" checked>
                                <span class="radio-custom"></span>
                                <span class="radio-label">PDF - Para impresi√≥n y documentos</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="format" value="png">
                                <span class="radio-custom"></span>
                                <span class="radio-label">PNG - Para presentaciones digitales</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4 class="form-section-title">Tama√±o y resoluci√≥n</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="page-size">Tama√±o de p√°gina</label>
                                <select id="page-size" name="pageSize" class="control">
                                    <option value="A4">A4 (210 √ó 297 mm)</option>
                                    <option value="A3">A3 (297 √ó 420 mm)</option>
                                    <option value="Letter">Carta (216 √ó 279 mm)</option>
                                    <option value="custom">Personalizado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dpi-select">Resoluci√≥n (DPI)</label>
                                <select id="dpi-select" name="dpi" class="control">
                                    <option value="150">150 DPI - Calidad est√°ndar</option>
                                    <option value="300">300 DPI - Alta calidad</option>
                                    <option value="600">600 DPI - M√°xima calidad</option>
                                    <option value="1200">1200 DPI - Calidad de impresi√≥n</option>
                                    <option value="2400" selected>2400 DPI - Calidad Ultra</option>
                                </select>
                            </div>
                        </div>

                        <div id="custom-size-section" class="form-row custom-size-section" style="display: none;">
                            <div class="form-group">
                                <label for="custom-width">Ancho (p√≠xeles)</label>
                                <input type="number" id="custom-width" name="customWidth" class="control" min="100"
                                    max="8000" value="2480">
                            </div>
                            <div class="form-group">
                                <label for="custom-height">Alto (p√≠xeles)</label>
                                <input type="number" id="custom-height" name="customHeight" class="control" min="100"
                                    max="8000" value="3508">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4 class="form-section-title">Elementos a incluir</h4>
                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="includeScale" checked>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Escala del mapa</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="includeLegend" checked>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Leyenda</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="includeAttribution" checked>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Atribuciones y fuentes</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="includeTimestamp" checked>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">Fecha y hora de generaci√≥n</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="includeTitle" checked>
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">T√≠tulo del mapa</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4 class="form-section-title">Informaci√≥n adicional</h4>
                        <div class="form-group">
                            <label for="map-title">T√≠tulo personalizado (opcional)</label>
                            <input type="text" id="map-title" name="mapTitle" class="control"
                                placeholder="Mapa SNIEn - Sistema Nacional de Informaci√≥n Energ√©tica">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary btn-cancel">Cancelar</button>
                <button type="button" class="btn-secondary btn-export-confirm">
                    <span class="btn-text">Exportar</span>
                    <span class="btn-spinner" style="display: none;">
                        <span class="spinner-small"></span>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Sistema de notificaciones -->
    <div id="notification-container" class="notification-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Overlay de progreso global -->
    <div id="export-progress-overlay" class="progress-overlay" style="display: none;">
        <div class="progress-content">
            <div class="progress-spinner"></div>
            <h4 class="progress-title">Exportando mapa...</h4>
            <p class="progress-message">Capturando imagen del mapa</p>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <p class="progress-percentage">0%</p>
        </div>
    </div>

    <!-- Core libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.6.1/maptiler-sdk.umd.min.js"></script>
    <script src="https://cdn.maptiler.com/leaflet-maptilersdk/v4.1.0/leaflet-maptilersdk.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <!-- Export dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-image@0.4.0/leaflet-image.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <!-- Modular JavaScript files -->
    <script src="js/export-config.js"></script>
    <script src="js/notification-system.js"></script>
    <script src="js/progress-system.js"></script>
    <script src="js/canvas-capture.js"></script>
    <script src="js/pdf-generator.js"></script>
    <script src="js/png-processor.js"></script>
    <script src="js/map-exporter.js"></script>
    <script src="js/export-ui.js"></script>
    <script src="js/map-config.js"></script>

</body>

</html>